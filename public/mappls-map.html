<!DOCTYPE html>
<html>
<head>
    <title>Xploraa - Mappls Map</title>
    <meta name="viewport" content="initial-scale=1.0">
    <meta charset="utf-8">
    <style>
        html,
        body,
        #map {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .btn {
            background: linear-gradient(135deg, #3b82f6, #8b5cf6);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: transform 0.2s;
        }
        
        .btn:hover {
            transform: scale(1.05);
        }
        
        .stats {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: rgba(255, 255, 255, 0.95);
            padding: 15px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            z-index: 1000;
            backdrop-filter: blur(10px);
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        
        .marker {
            animation: pulse 2s infinite;
        }

        /* Animated Character Styles */
        .animated-character {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #3b82f6, #8b5cf6);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
            transition: transform 0.3s ease;
            animation: bounce 2s infinite;
        }

        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% {
                transform: translateY(0);
            }
            40% {
                transform: translateY(-10px);
            }
            60% {
                transform: translateY(-5px);
            }
        }
    </style>
    <script src="https://apis.mappls.com/advancedmaps/api/b8a5269c-04a7-42cf-8501-3b1371f1ed73/map_sdk?layer=vector&v=3.0&callback=initMap1" defer async></script>
</head>
<body>
    <div id="map"></div>
    
    <!-- Stats -->
    <div class="stats">
        <div style="font-weight: bold; margin-bottom: 8px;">üéÆ Game Stats</div>
        <div style="font-size: 14px; color: #6b7280;">
            XP: <span style="color: #3b82f6; font-weight: bold;">1250</span><br>
            Places Visited: <span style="color: #10b981; font-weight: bold;">12</span><br>
            Level: <span style="color: #f59e0b; font-weight: bold;">5</span>
        </div>
    </div>

    <script>
        var map;
        var markers = [];
        
        // Your exact initialization function
        function initMap1() {
            console.log('üöÄ Initializing Mappls Map...');
            
            map = new mappls.Map('map', {
                center: [28.638698386592438 , 77.27604556863412 ],
                geolocation: true,
                zoomControl: true,
                zoom: 10
            });
            
            // Set zoom as in your example
            map.setZoom(20);
            
            // Update status
            document.getElementById('status').textContent = 'Map Loaded!';
            document.getElementById('status').style.color = '#10b981';
            
            // Add map event listeners
            map.on('zoom', function() {
                document.getElementById('zoom-level').textContent = map.getZoom();
            });
            
            map.on('click', function(e) {
                console.log('üñ±Ô∏è Map clicked at:', e.lngLat);
                addMarkerAt(e.lngLat.lng, e.lngLat.lat, 'Clicked Location', 'You found a secret spot! +50 XP');
            });
            
            // Handle geolocation success
            map.on('geolocate', function(e) {
                console.log('üìç Current location found:', e.coords);
                document.getElementById('status').textContent = 'Location Found!';
                
                // Add marker at current location
                addMarkerAt(e.coords.longitude, e.coords.latitude, 'üìç Your Current Location', 'This is where you are right now!', 'user');
            });
            
            console.log('‚úÖ Mappls Map initialized successfully!');
            
            // Auto detect user location after 1 second
            setTimeout(() => {
                console.log('üîç Auto-detecting user location...');
                getUserLocation();
            }, 1000);
            
            // Auto add some sample markers after 3 seconds
            setTimeout(addMarkers, 3000);
        }
        
        // Control functions
        function zoomIn() {
            if (map) {
                map.setZoom(map.getZoom() + 1);
            }
        }
        
        function zoomOut() {
            if (map) {
                map.setZoom(map.getZoom() - 1);
            }
        }
        
        function addMarkers() {
            if (!map) return;
            
            console.log('üìç Adding place markers...');
            
            // Sample Delhi places with slight coordinate variations around the center
            const places = [
                { name: 'Red Fort', lat: 28.6562, lng: 77.2410, xp: 100, type: 'historic' },
                { name: 'India Gate', lat: 28.6129, lng: 77.2295, xp: 150, type: 'historic' },
                { name: 'Lotus Temple', lat: 28.5535, lng: 77.2588, xp: 80, type: 'temple' },
                { name: 'Qutub Minar', lat: 28.5244, lng: 77.1855, xp: 120, type: 'historic' },
                { name: 'Connaught Place', lat: 28.6315, lng: 77.2167, xp: 200, type: 'food' },
                { name: 'Chandni Chowk', lat: 28.6506, lng: 77.2301, xp: 180, type: 'food' }
            ];
            
            places.forEach((place, index) => {
                setTimeout(() => {
                    addMarkerAt(place.lng, place.lat, place.name, `Visit ${place.name} and earn ${place.xp} XP!`, place.type);
                }, index * 500); // Staggered animation
            });
        }
        
        function addMarkerAt(lng, lat, title, description, type = 'default') {
            if (!map) return;
            
            // Create marker with custom styling
            const marker = new mappls.Marker({
                map: map,
                position: { lat: lat, lng: lng },
                icon_url: getMarkerIcon(type),
                width: 40,
                height: 40,
                fitbounds: false
            });
            
            // Add info window
            const infoWindow = new mappls.InfoWindow({
                map: map,
                position: { lat: lat, lng: lng },
                content: `
                    <div style="padding: 15px; min-width: 200px; text-align: center;">
                        <h3 style="margin: 0 0 10px 0; color: #1f2937; font-weight: bold;">${title}</h3>
                        <p style="margin: 0 0 15px 0; color: #6b7280; font-size: 14px;">${description}</p>
                        <button onclick="visitPlace('${title}')" style="
                            background: linear-gradient(135deg, #3b82f6, #8b5cf6);
                            color: white;
                            border: none;
                            padding: 8px 16px;
                            border-radius: 6px;
                            cursor: pointer;
                            font-weight: 500;
                        ">üéØ Visit Place</button>
                    </div>
                `
            });
            
            // Add click event to marker
            marker.on('click', function() {
                infoWindow.open();
            });
            
            markers.push(marker);
            console.log(`‚úÖ Added marker for: ${title}`);
        }
        
        function getMarkerIcon(type) {
            const icons = {
                historic: 'https://apis.mapmyindia.com/map_v3/1.3/png?marker=8b5cf6|15&=',
                museum: 'https://apis.mapmyindia.com/map_v3/1.3/png?marker=3b82f6|15&=',
                temple: 'https://apis.mapmyindia.com/map_v3/1.3/png?marker=f59e0b|15&=',
                food: 'https://apis.mapmyindia.com/map_v3/1.3/png?marker=10b981|15&=',
                default: 'https://apis.mapmyindia.com/map_v3/1.3/png?marker=ef4444|15&='
            };
            return icons[type] || icons.default;
        }
        
        function visitPlace(placeName) {
            alert(`üéâ Congratulations! You visited ${placeName}!\n\n+100 XP earned!\nüéÅ Special coupon unlocked!`);
            console.log(`üéØ Player visited: ${placeName}`);
        }
        
        function getUserLocation() {
            if (!navigator.geolocation) {
                alert('Geolocation is not supported by this browser.');
                return;
            }
            
            console.log('üìç Getting user location...');
            
            navigator.geolocation.getCurrentPosition(
                function(position) {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    
                    console.log(`üìç User location: ${lat}, ${lng}`);
                    
                    // Update map center to user's current location
                    if (map) {
                        map.setCenter([lng, lat]);
                        map.setZoom(16);
                    }
                    
                    // Add user marker
                    addMarkerAt(lng, lat, 'üìç Your Current Location', 'This is where you are right now!', 'user');
                    
                    // Update status
                    document.getElementById('status').textContent = 'Centered on your location!';
                    document.getElementById('status').style.color = '#10b981';
                },
                function(error) {
                    console.error('Geolocation error:', error);
                    alert('Unable to get your location. Please enable location services.');
                    
                    // Update status
                    document.getElementById('status').textContent = 'Location access denied';
                    document.getElementById('status').style.color = '#ef4444';
                }
            );
        }
        
        // ===== ANIMATED CHARACTER FUNCTIONALITY =====
        var animatedCharacter = null;
        var isCharacterAnimating = false;
        var currentCharacterIndex = 0;
        var characters = ['üö∂‚Äç‚ôÇÔ∏è', 'üèÉ‚Äç‚ôÇÔ∏è', 'üö¥‚Äç‚ôÇÔ∏è', 'üßë‚Äçüíª', 'üë®‚ÄçüéÆ', 'ü¶∏‚Äç‚ôÇÔ∏è', 'ü•∑', 'üë®‚ÄçüöÄ'];
        var characterNames = ['Walker', 'Runner', 'Cyclist', 'Coder', 'Gamer', 'Hero', 'Ninja', 'Astronaut'];

        function createAnimatedCharacter() {
            if (!map) return;
            
            console.log('üë§ Creating animated character...');
            
            animatedCharacter = new mappls.Marker({
                map: map,
                width: 50,
                height: 50,
                html: `<div id="xploraa-character" class="animated-character">
                         ${characters[currentCharacterIndex]}
                       </div>`,
                offset: [0, -25],
                position: {lat: 28.638698386592438, lng: 77.27604556863412},
                fitbounds: false
            });
            
            animatedCharacter['id'] = "xploraa-character";
            updateCharacterStatus('Character Ready');
            console.log('‚úÖ Animated character created!');
        }

        function startCharacterAnimation() {
            if (isCharacterAnimating) {
                console.log('‚ö†Ô∏è Character animation already running');
                return;
            }
            
            if (!animatedCharacter) {
                createAnimatedCharacter();
            }
            
            isCharacterAnimating = true;
            updateCharacterStatus('Exploring...');
            console.log('üöÄ Starting character animation...');
            
            // Delhi area exploration route
            var explorationRoute = [
                {lat: 28.640000, lng: 77.276000},
                {lat: 28.642000, lng: 77.278000},
                {lat: 28.641000, lng: 77.280000},
                {lat: 28.639000, lng: 77.279000},
                {lat: 28.637000, lng: 77.277000},
                {lat: 28.636000, lng: 77.275000},
                {lat: 28.638000, lng: 77.273000},
                {lat: 28.640000, lng: 77.274000},
                {lat: 28.638698386592438, lng: 77.27604556863412}
            ];
            
            explorationRoute.forEach((location, i) => {
                setTimeout(() => {
                    if (!isCharacterAnimating) return;
                    
                    var speed = 8;
                    smoothNavigateCharacter(animatedCharacter, location, speed);
                    
                    // Change character expression during journey
                    if (i % 2 === 0) {
                        updateCharacterExpression('üèÉ‚Äç‚ôÇÔ∏è');
                    } else {
                        updateCharacterExpression('üö∂‚Äç‚ôÇÔ∏è');
                    }
                }, (3000 * i));
            });
            
            // Reset after animation
            setTimeout(() => {
                if (isCharacterAnimating) {
                    isCharacterAnimating = false;
                    updateCharacterStatus('Journey Complete!');
                    updateCharacterExpression(characters[currentCharacterIndex]);
                }
            }, (3000 * explorationRoute.length) + 2000);
        }

        function stopCharacterAnimation() {
            isCharacterAnimating = false;
            updateCharacterStatus('Stopped');
            updateCharacterExpression(characters[currentCharacterIndex]);
            console.log('‚èπÔ∏è Character animation stopped');
        }

        function changeCharacter() {
            currentCharacterIndex = (currentCharacterIndex + 1) % characters.length;
            var newCharacter = characters[currentCharacterIndex];
            var characterName = characterNames[currentCharacterIndex];
            
            updateCharacterExpression(newCharacter);
            document.getElementById('current-character').textContent = newCharacter;
            updateCharacterStatus(`Changed to ${characterName}`);
            
            console.log(`üë§ Character changed to: ${characterName} ${newCharacter}`);
        }

        function updateCharacterExpression(emoji) {
            var characterElement = document.getElementById('xploraa-character');
            if (characterElement) {
                characterElement.innerHTML = emoji;
            }
        }

        function updateCharacterStatus(status) {
            var statusElement = document.getElementById('character-status');
            if (statusElement) {
                statusElement.textContent = status;
            }
        }

        function smoothNavigateCharacter(obj, setPos, speed) {
            if (speed != undefined && speed) {
                var coordinates = [];
                var currentPos = obj.getPosition();
                var targetPos = setPos;
                var distance = getDistanceFromLatLonInKm(currentPos.lat, currentPos.lng, targetPos.lat, targetPos.lng);
                var heading = angleFromCoordinate(currentPos.lat, currentPos.lng, targetPos.lat, targetPos.lng);
                var steps = Math.max(Math.round(distance / speed), 1);
                
                for (var i = 1; i <= steps; i++) {
                    coordinates.push({
                        lat: currentPos.lat + (targetPos.lat - currentPos.lat) * (i / steps),
                        lng: currentPos.lng + (targetPos.lng - currentPos.lng) * (i / steps)
                    });
                }
                
                coordinates.forEach((coord, index) => {
                    setTimeout(() => {
                        if (!isCharacterAnimating) return;
                        
                        obj.setPosition(coord);
                        
                        var characterElement = document.getElementById(obj.id);
                        if (characterElement) {
                            characterElement.style.transform = `rotate(${heading}deg)`;
                            
                            if (index % 2 === 0) {
                                characterElement.style.transform += ' scale(1.1)';
                            } else {
                                characterElement.style.transform += ' scale(1.0)';
                            }
                        }
                    }, 100 * index);
                });
            } else {
                obj.setPosition(setPos);
            }
        }

        function angleFromCoordinate(lat1, lon1, lat2, lon2) {
            var p1 = { x: lat1, y: lon1 };
            var p2 = { x: lat2, y: lon2 };
            var angleDeg = Math.atan2(p2.y - p1.y, p2.x - p1.x) * 180 / Math.PI;
            return angleDeg;
        }
        
        // Initialize when DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üéÆ Xploraa Map Ready!');
            
            // Auto-create character after 5 seconds
            setTimeout(() => {
                createAnimatedCharacter();
            }, 5000);
        });
    </script>
</body>
</html>
